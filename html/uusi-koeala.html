<!DOCTYPE html>
<script src="../js/ipcRenderer.js"></script>

<html>
    <head>
        <title>MUTU</title>
        <meta charset="UTF-8">
        <!--link rel="stylesheet" type="text/css" href="../css/Jylli.css">-->
    </head>

    <body>
        <h1>Uusi koeala</h1>
        <div>
            <label for="koealaName">Koealan nimi: </label>
            <input type="text" id="koealaName" name="koealaName"><br>

            <label for="koealatemplates">Valitse koealapohja:</label>
            <select name="koealatemplates" id="koealatemplates"> 
            </select> 

            <!--JOKU TEMPLATE PREVIEW-->

            <button onclick='createAla()'>OK</button>
            <!--MIKSI PERUUTA-NAPPI TOIMII??-->
            <button onclick='renderPage("Koekalastus")'>Peruuta</button>
        </div>
    </body>
</html>

<script>
    ipcRenderer.on("koekalastus-data" , (event, ipcReceive) => {
        ipcData = ipcReceive
    })
    
    ipcRenderer.on("data-for-renderer", (event, ipcFetch) => {
        ipcData = ipcFetch

        switch(step) {
            case 1:
                koealaId = ipcData
                fetchTemplateLinks()
                break;
            case 2:
                templateLinks = ipcData
                linkKoealaKaominaisuudet(ipcData)
                break;
            case 3:
                proceedPage()
                break;
        }
        step++
    })

    function createAla(){
        let sqlInsert = `INSERT INTO koealat VALUES(null,'${document.querySelector("#koealaName").value}','${ipcData["avain"]}' , false, false)`
        ipcRenderer.send("insert-data", sqlInsert)
    }

    function fetchTemplateLinks(){
        let fetch_sql = `SELECT * FROM link_koelalat_kaominaisuudet WHERE id_koealat = (SELECT (id) FROM koealat WHERE nimi = "${document.querySelector("#koealatemplates").value}")`
        ipcRenderer.send("fetch-data", fetch_sql)
    }
    
    function linkKoealaKaominaisuudet(){
        let sqlInsert = "INSERT INTO link_koelalat_kaominaisuudet VALUES "
        templateLinks.forEach(row => {
            sqlInsert += (`(${koealaId},${row["id_kaominaisuudet"]},${row["tiedot"]}),`)
        })
        sqlInsert = sqlInsert.slice(0, -1)

        ipcRenderer.send("insert-data", sqlInsert)
    }

    function proceedPage(){
        renderPage("koeala", koealaId)
    }

    let step = 1
    let ipcData = null
    let koealaId = null
    let templateLinks = null
    document.querySelector("#koealatemplates").textContent += "<br><option values='Köhniö'>Köhniö</option>"
    </script>